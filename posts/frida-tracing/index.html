<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    

    
    
    
    <title>
         Observing the effects of an iOS button with Frida
        
    </title>

        
            <meta property="og:title" content="Observing the effects of an iOS button with Frida" />
        
     

     
         
     

     
         
    

    
    

    
    
        <link href=https://saml98.github.io/fonts.css rel="stylesheet" />
    

    
    


    

    
    <link rel="alternate" type="application/atom+xml" title="Sam&#x27;s Internet Home" href="https://saml98.github.io/atom.xml">

    
    
    
        <link rel="stylesheet" type="text/css" href="https://saml98.github.io/theme/light.css"/>
        <link rel="stylesheet" type="text/css" href="https://saml98.github.io/theme/dark.css" media="(prefers-color-scheme: dark)"/>
    

    
        <script src=https://saml98.github.io/js/themetoggle.js></script>

        
            <script>
                if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    setTheme("dark");
                } else {
                    setTheme("light");
                }
            </script>
        
    

    <link rel="stylesheet" type="text/css" media="screen" href=https://saml98.github.io/main.css />


    
</head>


<script data-goatcounter="https://saml98.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>

<body>
    <div class="content">
        <header>
    <div class="main">
        <a href=https:&#x2F;&#x2F;saml98.github.io>Sam&#x27;s Internet Home</a>
    </div>

    <nav>
        
            <a href=&#x2F;posts style="margin-left: 0.7em">&#x2F;posts</a>
        
            <a href=&#x2F;projects style="margin-left: 0.7em">&#x2F;projects</a>
        
            <a href=&#x2F;about style="margin-left: 0.7em">&#x2F;about</a>
        

        
    </nav>
</header>


        
        
    
<main>
    <article>
        <div class="title">
            
            
    <div class="page-header">
        Observing the effects of an iOS button with Frida<span class="primary-color" style="font-size: 1.6em">.</span>
    </div>


                <div class="meta">
                    
                        Posted on <time>2020-10-08</time>
                    

                    
                </div>
        </div>

        

        
        

        <section class="body">
            <p>I don't really know how to reverse engineer iOS apps. I don't know about tracing network calls, system calls, or whatever. What I do know is that when I tap a button, eventually something that I care about happens.</p>
<p>For example, this post is once again brought to you by Spotify. I get mad that every time I want to a) search a song and b) play that song right away, if I select the search result directly, my playing context will switch to the search results. That is if I search &quot;Music&quot; and play &quot;Music&quot; by Peven Everett, the next song played might be &quot;Listen to the Music&quot; by The Doobie Brothers rather than the next song in the shuffle. What I want to happen is the song to play and once finished, return to the previous context.</p>
<h2 id="finding-the-tableview-cell">Finding the TableView Cell</h2>
<p>In order to observe the different effects of playing a song when searching and not searching, we first need to find a trigger on when to start tracing method calls. Knowing a little bit of iOS programming, we know that (assuming Spotify isn't doing anything too custom) the song should displayed with a subclass of <code>UITableViewCell</code> and that should contain a label (subclassed from <code>UILabel</code>) that constains the song name.</p>
<p>So with Frida, the first thing we can do is get the entire view hierarchy. That is, just get an array of all views displayed.</p>
<p>This can be done with BFS on the key window:</p>
<pre data-lang="javascript" style="background-color:#2b303b;color:#c0c5ce;" class="language-javascript "><code class="language-javascript" data-lang="javascript"><span style="color:#b48ead;">var </span><span style="color:#8fa1b3;">get_all_views </span><span>= </span><span style="color:#b48ead;">function</span><span>() {
</span><span>    </span><span style="color:#b48ead;">var </span><span style="color:#bf616a;">root </span><span>= </span><span style="color:#bf616a;">ObjC</span><span>.classes.</span><span style="color:#bf616a;">UIWindow</span><span>.</span><span style="color:#8fa1b3;">keyWindow</span><span>(); </span><span style="color:#65737e;">// The root of the view hierarchy
</span><span>    </span><span style="color:#b48ead;">var </span><span style="color:#bf616a;">buff </span><span>= [root];                            </span><span style="color:#65737e;">// The views left to traverse
</span><span>    </span><span style="color:#b48ead;">var </span><span style="color:#bf616a;">visited </span><span>= [];                             </span><span style="color:#65737e;">// The views we have already traversed
</span><span>
</span><span>    </span><span style="color:#b48ead;">while </span><span>(</span><span style="color:#bf616a;">buff</span><span>.length &gt; </span><span style="color:#d08770;">0</span><span>) {
</span><span>        </span><span style="color:#b48ead;">var </span><span style="color:#bf616a;">node </span><span>= </span><span style="color:#bf616a;">buff</span><span>.</span><span style="color:#96b5b4;">shift</span><span>();
</span><span>
</span><span>        </span><span style="color:#65737e;">// Make sure we don&#39;t traverse a view twice
</span><span>        </span><span style="color:#b48ead;">if </span><span>(</span><span style="color:#bf616a;">visited</span><span>.</span><span style="color:#96b5b4;">indexOf</span><span>(</span><span style="color:#bf616a;">node</span><span>) &gt;= </span><span style="color:#d08770;">0</span><span>)
</span><span>            </span><span style="color:#b48ead;">continue</span><span>;
</span><span>
</span><span>        </span><span style="color:#bf616a;">visited</span><span>.</span><span style="color:#96b5b4;">push</span><span>(</span><span style="color:#bf616a;">node</span><span>);
</span><span>
</span><span>        </span><span style="color:#65737e;">// Iterate over all the view&#39;s subviews
</span><span>        </span><span style="color:#b48ead;">var </span><span style="color:#bf616a;">children </span><span>= </span><span style="color:#bf616a;">node</span><span>.</span><span style="color:#8fa1b3;">subviews</span><span>();
</span><span>
</span><span>        </span><span style="color:#b48ead;">for </span><span>(</span><span style="color:#b48ead;">var </span><span style="color:#bf616a;">i</span><span>=</span><span style="color:#d08770;">0</span><span>; </span><span style="color:#bf616a;">i</span><span>&lt;</span><span style="color:#bf616a;">children</span><span>.</span><span style="color:#8fa1b3;">count</span><span>(); </span><span style="color:#bf616a;">i</span><span>++) {
</span><span>            </span><span style="color:#b48ead;">var </span><span style="color:#bf616a;">child </span><span>= </span><span style="color:#bf616a;">children</span><span>[&#39;</span><span style="color:#a3be8c;">- objectAtIndex:</span><span>&#39;](</span><span style="color:#bf616a;">i</span><span>);
</span><span>
</span><span>            </span><span style="color:#b48ead;">if </span><span>(</span><span style="color:#bf616a;">visited</span><span>.</span><span style="color:#96b5b4;">indexOf</span><span>(</span><span style="color:#bf616a;">child</span><span>) == -</span><span style="color:#d08770;">1</span><span>)
</span><span>                </span><span style="color:#bf616a;">buff</span><span>.</span><span style="color:#96b5b4;">push</span><span>(</span><span style="color:#bf616a;">child</span><span>);
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">visited</span><span>;
</span><span>}
</span></code></pre>
<p>We can then get all of the <code>UILabel's</code> (presumably) with the following:</p>
<pre data-lang="javascript" style="background-color:#2b303b;color:#c0c5ce;" class="language-javascript "><code class="language-javascript" data-lang="javascript"><span style="color:#bf616a;">labels </span><span>= </span><span style="color:#bf616a;">views</span><span>.</span><span style="color:#8fa1b3;">filter</span><span>(</span><span style="color:#b48ead;">function</span><span>(</span><span style="color:#bf616a;">v</span><span>) { </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">v</span><span>.</span><span style="color:#bf616a;">$className</span><span>.</span><span style="color:#96b5b4;">indexOf</span><span>(&#39;</span><span style="color:#a3be8c;">Label</span><span>&#39;) &gt;= </span><span style="color:#d08770;">0</span><span>; });
</span></code></pre>
<p>We can get the whole view hierarchy for just the chosen label (the one with a song name in it). I'll refer to this as the view's stack. Note that this isn't really a stack but whatever.</p>
<pre data-lang="javascript" style="background-color:#2b303b;color:#c0c5ce;" class="language-javascript "><code class="language-javascript" data-lang="javascript"><span style="color:#b48ead;">var </span><span style="color:#8fa1b3;">get_view_stack </span><span>= </span><span style="color:#b48ead;">function</span><span>(</span><span style="color:#bf616a;">view</span><span>) {
</span><span>    </span><span style="color:#b48ead;">var </span><span style="color:#bf616a;">stack </span><span>= [];
</span><span>
</span><span>    </span><span style="color:#b48ead;">while </span><span>(</span><span style="color:#bf616a;">view</span><span>.</span><span style="color:#8fa1b3;">superview</span><span>() != </span><span style="color:#d08770;">null</span><span>) {
</span><span>        </span><span style="color:#bf616a;">stack</span><span>.</span><span style="color:#96b5b4;">push</span><span>(</span><span style="color:#bf616a;">view</span><span>);
</span><span>        </span><span style="color:#bf616a;">view </span><span>= </span><span style="color:#bf616a;">view</span><span>.</span><span style="color:#8fa1b3;">superview</span><span>();
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">stack</span><span>;
</span><span>}
</span></code></pre>
<p>Finally, we can print out the label view's stack to get the class of the table view:</p>
<p><img src="/frida_view_stack.png" alt="view_stack" /></p>
<p>Again, using our knowledge of iOS programming and assuming that Spotify isn't doing anything weird, we assume that the <code>SPTYourLibraryMusicSongsViewController</code> class is the table view cell's delegate and therefore has a <code>- tableView:didSelectRowAtIndexPath:</code> that will be called when tapped.</p>
<h2 id="tracing-the-tap">Tracing the Tap</h2>
<p>Know that we've found the method we want to trace, we need to actually trace it with Frida. This is surprisingly simple using Frida Stalker.</p>
<p>First, we need to calculate the ASLR slide:</p>
<pre data-lang="javascript" style="background-color:#2b303b;color:#c0c5ce;" class="language-javascript "><code class="language-javascript" data-lang="javascript"><span style="color:#b48ead;">var </span><span style="color:#bf616a;">impl </span><span>= </span><span style="color:#bf616a;">ObjC</span><span>.classes.</span><span style="color:#bf616a;">SPTYourLibraryMusicSongsViewController</span><span>[&#39;</span><span style="color:#a3be8c;">- tableView:didSelectRowAtIndexPath:</span><span>&#39;].implementation;
</span><span style="color:#b48ead;">var </span><span style="color:#bf616a;">slide </span><span>= </span><span style="color:#96b5b4;">parseInt</span><span>(</span><span style="color:#bf616a;">impl</span><span>) - </span><span style="color:#d08770;">0x102ef6040</span><span>;
</span></code></pre>
<p>where 0x102ef6040 is the static imp pointer for the delegate method obtained from the Objective-C metadata.</p>
<p>What we'll do is start stalking the current thread when the delegate method is called:</p>
<pre data-lang="javascript" style="background-color:#2b303b;color:#c0c5ce;" class="language-javascript "><code class="language-javascript" data-lang="javascript"><span style="color:#bf616a;">Interceptor</span><span>.</span><span style="color:#8fa1b3;">attach</span><span>(</span><span style="color:#bf616a;">impl</span><span>, {
</span><span>    </span><span style="color:#8fa1b3;">onEnter</span><span>: </span><span style="color:#b48ead;">function</span><span>(</span><span style="color:#bf616a;">args</span><span>) {
</span><span>        </span><span style="color:#ebcb8b;">console</span><span>.</span><span style="color:#96b5b4;">log</span><span>(&#39;</span><span style="color:#a3be8c;">Hit trigger</span><span>&#39;);
</span><span>
</span><span>        </span><span style="color:#b48ead;">var </span><span style="color:#bf616a;">tid </span><span>= </span><span style="color:#bf616a;">Process</span><span>.</span><span style="color:#8fa1b3;">getCurrentThreadId</span><span>();
</span><span>        </span><span style="color:#ebcb8b;">console</span><span>.</span><span style="color:#96b5b4;">log</span><span>(&#39;</span><span style="color:#a3be8c;">Stalking thread </span><span>&#39; + </span><span style="color:#bf616a;">tid</span><span>);
</span><span>
</span><span>        </span><span style="color:#bf616a;">Stalker</span><span>.</span><span style="color:#8fa1b3;">follow</span><span>(</span><span style="color:#bf616a;">tid</span><span>, {
</span><span>            events: {
</span><span>                call: </span><span style="color:#d08770;">true</span><span>,
</span><span>                ret: </span><span style="color:#d08770;">false</span><span>,
</span><span>                exec: </span><span style="color:#d08770;">false</span><span>,
</span><span>                block: </span><span style="color:#d08770;">false</span><span>,
</span><span>                compile: </span><span style="color:#d08770;">false</span><span>,
</span><span>            },
</span></code></pre>
<p>where only <code>call</code> is true in the Stalker arguments since we only care about which methods are called, not the individual instructions being executed.</p>
<p>We then need to parse each Stalker events. I don't want to go through the methodology here, but I started by printing the call summaries (which address and number of times called), but I got that none of the actual class imps were being called but a function at 0x102f2432c was being called more than any other function. Sure enough that points to <code>objc_msgSend</code>, the dispatch function for every (well, most) Objective-C method calls. So what we want to do is actually print out the id's and selectors being passed to <code>objc_msgSend</code>. However, I couldn't figure out how to do that with Frida, so I ended up printing out the calling address to <code>objc_msgSend</code>. I figured you could later just disassemble at that address to get the method called.</p>
<pre data-lang="javascript" style="background-color:#2b303b;color:#c0c5ce;" class="language-javascript "><code class="language-javascript" data-lang="javascript"><span>            onReceive: </span><span style="color:#b48ead;">function</span><span>(</span><span style="color:#bf616a;">events</span><span>) {
</span><span>                </span><span style="color:#65737e;">// Parse the events
</span><span>                </span><span style="color:#b48ead;">var </span><span style="color:#bf616a;">events_ </span><span>= </span><span style="color:#bf616a;">Stalker</span><span>.</span><span style="color:#96b5b4;">parse</span><span>(</span><span style="color:#bf616a;">events</span><span>, {
</span><span>                    stringify: </span><span style="color:#d08770;">true
</span><span>                });
</span><span>                
</span><span>                </span><span style="color:#bf616a;">events_</span><span>.</span><span style="color:#96b5b4;">forEach</span><span>(</span><span style="color:#b48ead;">function</span><span>(</span><span style="color:#bf616a;">ev</span><span>) {
</span><span>                    </span><span style="color:#65737e;">// Unslide the call target
</span><span>                    </span><span style="color:#b48ead;">var </span><span style="color:#bf616a;">target </span><span>= </span><span style="color:#96b5b4;">parseInt</span><span>(</span><span style="color:#bf616a;">ev</span><span>[</span><span style="color:#d08770;">2</span><span>]) - </span><span style="color:#bf616a;">slide</span><span>;
</span><span>                
</span><span>                    </span><span style="color:#65737e;">// objc_msgSend was called
</span><span>                    </span><span style="color:#b48ead;">if </span><span>(</span><span style="color:#bf616a;">target </span><span>=== </span><span style="color:#d08770;">0x102f2432c</span><span>) {
</span><span>                        </span><span style="color:#65737e;">// Print the unslid calling address
</span><span>                        </span><span style="color:#b48ead;">var </span><span style="color:#bf616a;">calling_addr </span><span>= </span><span style="color:#96b5b4;">parseInt</span><span>(</span><span style="color:#bf616a;">ev</span><span>[</span><span style="color:#d08770;">1</span><span>]) - </span><span style="color:#bf616a;">slide</span><span>;
</span><span>                        </span><span style="color:#ebcb8b;">console</span><span>.</span><span style="color:#96b5b4;">log</span><span>(</span><span style="color:#bf616a;">calling_addr</span><span>.</span><span style="color:#96b5b4;">toString</span><span>(</span><span style="color:#d08770;">16</span><span>));
</span><span>                    }
</span><span>                });
</span><span>            }
</span></code></pre>
<h2 id="sybmolicating-the-log">Sybmolicating the Log</h2>
<p>We now get a long list of addresses which have a <code>bl(x) objc_msgSend</code> instruction:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>102ef6088
</span><span>101898648
</span><span>10189865c
</span><span>101898678
</span><span>102ef60a4
</span><span>102ef60c0
</span><span>102ef60d4
</span><span>102ef60f0
</span><span>...
</span></code></pre>
<p>and would at least like to see which method contained the method call. </p>
<p>To do that, we'll create a map of imp pointers to method names (class name + selector). But to create that, we first need to be able to parse the Objective-C class metadata into a well-formatted data structure.</p>
<p>I previously had some scripts to do this in radare, but since radare sucks, I converted it into a Ghidra script which can be found <a href="https://gist.github.com/SamL98/9456290c3ac1399763bd23ae194d556a">here</a>.</p>
<p>This will give you a file named <code>classes.json</code> structured as:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>&lt;class name&gt;: {
</span><span>    methods: {
</span><span>        &lt;selector&gt;: &lt;imp pointer&gt;,
</span><span>        ...
</span><span>    },
</span><span>    ivars: {
</span><span>        &lt;name&gt;: &lt;type&gt;,
</span><span>        ...
</span><span>    }
</span><span>}
</span></code></pre>
<p>we can then reverse this map like so:</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span>imp_map = {}
</span><span>
</span><span style="color:#b48ead;">for </span><span>cname, klass </span><span style="color:#b48ead;">in </span><span>classes.</span><span style="color:#bf616a;">items</span><span>():
</span><span>    </span><span style="color:#b48ead;">for </span><span>sel, imp </span><span style="color:#b48ead;">in </span><span>klass[&#39;</span><span style="color:#a3be8c;">methods</span><span>&#39;].</span><span style="color:#bf616a;">items</span><span>():
</span><span>        imp_map[imp] = cname + &#39;</span><span style="color:#a3be8c;">.</span><span>&#39; + sel
</span></code></pre>
<p>to get our desired mapping.</p>
<p>We can then do a binary search on the keys of this map to find out the method that each call site resides in (don't judge me if the bsearch isn't canon):</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">bsearch</span><span>(</span><span style="color:#bf616a;">addr</span><span>, </span><span style="color:#bf616a;">imp_addrs</span><span>):
</span><span>    i, j = </span><span style="color:#d08770;">1</span><span>, </span><span style="color:#96b5b4;">len</span><span>(imp_addrs)
</span><span>
</span><span>    </span><span style="color:#b48ead;">while </span><span>(j - i) &gt; </span><span style="color:#d08770;">1</span><span>:
</span><span>        m = (i + j) // </span><span style="color:#d08770;">2
</span><span>
</span><span>        </span><span style="color:#b48ead;">if </span><span>addr &gt; imp_addrs[m]:
</span><span>            i = m
</span><span>        </span><span style="color:#b48ead;">else</span><span>:
</span><span>            j = m
</span><span>
</span><span>    </span><span style="color:#b48ead;">return </span><span>imp_addrs[i]
</span><span>
</span><span>imp_addrs = </span><span style="color:#96b5b4;">sorted</span><span>([</span><span style="color:#bf616a;">int</span><span>(k) </span><span style="color:#b48ead;">for </span><span>k </span><span style="color:#b48ead;">in </span><span>imps.</span><span style="color:#bf616a;">keys</span><span>()])
</span><span>
</span><span style="color:#b48ead;">for </span><span>addr </span><span style="color:#b48ead;">in </span><span>calling_addrs:
</span><span>    func = </span><span style="color:#bf616a;">bsearch</span><span>(addr, imp_addrs)
</span><span>    func_name = imps.</span><span style="color:#bf616a;">get</span><span>(</span><span style="color:#bf616a;">str</span><span>(func), &#39;&#39;)
</span><span>    </span><span style="color:#96b5b4;">print</span><span>(</span><span style="color:#96b5b4;">hex</span><span>(addr), </span><span style="color:#96b5b4;">hex</span><span>(func), func_name)
</span></code></pre>
<p>and our log is magically converted into</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>0x102ef6088 0x102ef6040 SPTYourLibraryMusicSongsViewController.tableView:didSelectRowAtIndexPath:
</span><span>0x101898648 0x101898620 SPTSwipeableTableViewCell.setSelected:animated:
</span><span>0x10189865c 0x101898620 SPTSwipeableTableViewCell.setSelected:animated:
</span><span>0x101898678 0x101898620 SPTSwipeableTableViewCell.setSelected:animated:
</span><span>0x102ef60a4 0x102ef6040 SPTYourLibraryMusicSongsViewController.tableView:didSelectRowAtIndexPath:
</span><span>0x102ef60c0 0x102ef6040 SPTYourLibraryMusicSongsViewController.tableView:didSelectRowAtIndexPath:
</span><span>0x102ef60d4 0x102ef6040 SPTYourLibraryMusicSongsViewController.tableView:didSelectRowAtIndexPath:
</span><span>0x102ef60f0 0x102ef6040 SPTYourLibraryMusicSongsViewController.tableView:didSelectRowAtIndexPath:
</span><span>...
</span></code></pre>
<p>which seems reasonable. Unfortunately, we still have to a) figure out which method(s) diverge in the traces of a normal tap and a tap while in search mode and b) manually disassemble/decompile interesting methods in the trace to recover the full control flow since all we get are callsites -- not called methods for free.</p>
<h3 id="conclusion">Conclusion</h3>
<p>I got bored with manually sifting through the log and manually analyzing each interesting method so I didn't really achieve what I wanted to with this. Regardless, I thought there were some useful tidbits in here that someone might find useful some day. Enjoy.</p>

        </section>

        

    </article>
</main>


    </div>
</body>

</html>
